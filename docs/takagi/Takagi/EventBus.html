<!DOCTYPE html>
<html>
  <head>
    <base href="/docs/takagi/">
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: Takagi::EventBus
  
    &mdash; Documentation by YARD 0.9.38
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "Takagi::EventBus";
  relpath = '../';
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-M7YHJSNC1F"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-M7YHJSNC1F');
    </script>
  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../_index.html">Index (E)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../Takagi.html" title="Takagi (module)">Takagi</a></span></span>
     &raquo; 
    <span class="title">EventBus</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: Takagi::EventBus
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Takagi::EventBus</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/takagi/event_bus.rb<span class="defines">,<br />
  lib/takagi/event_bus/scope.rb,<br /> lib/takagi/event_bus/future.rb,<br /> lib/takagi/event_bus/lru_cache.rb,<br /> lib/takagi/event_bus/coap_bridge.rb,<br /> lib/takagi/event_bus/address_prefix.rb,<br /> lib/takagi/event_bus/async_executor.rb,<br /> lib/takagi/event_bus/message_buffer.rb,<br /> lib/takagi/event_bus/observer_cleanup.rb</span>
</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>High-level event distribution with threaded/process async delivery. Built on top of ObserveRegistry with zero runtime dependencies.</p>

<p>Supports both CoAP Observe style and Pub/Sub style APIs:</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
        <h5 class="example_title"><div class='inline'>
<p>CoAP Observe style</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'>EventBus</span><span class='period'>.</span><span class='id identifier rubyid_observe'>observe</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sensor.temperature.room1</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_msg'>msg</span><span class='op'>|</span> <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span> <span class='rbrace'>}</span>
<span class='const'>EventBus</span><span class='period'>.</span><span class='id identifier rubyid_notify'>notify</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sensor.temperature.room1</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='lbrace'>{</span> <span class='label'>value:</span> <span class='float'>25.5</span> <span class='rbrace'>}</span><span class='rparen'>)</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'>
<p>Pub/Sub style (aliases)</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'>EventBus</span><span class='period'>.</span><span class='id identifier rubyid_consumer'><span class='object_link'><a href="#consumer-class_method" title="Takagi::EventBus.consumer (method)">consumer</a></span></span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sensor.temperature.room1</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_msg'>msg</span><span class='op'>|</span> <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span> <span class='rbrace'>}</span>
<span class='const'>EventBus</span><span class='period'>.</span><span class='id identifier rubyid_publish'><span class='object_link'><a href="#publish-class_method" title="Takagi::EventBus.publish (method)">publish</a></span></span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sensor.temperature.room1</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='lbrace'>{</span> <span class='label'>value:</span> <span class='float'>25.5</span> <span class='rbrace'>}</span><span class='rparen'>)</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'>
<p>Request-Reply pattern</p>
</div></h5>
      
      <pre class="example code"><code><span class='id identifier rubyid_reply'>reply</span> <span class='op'>=</span> <span class='const'>EventBus</span><span class='period'>.</span><span class='id identifier rubyid_send_sync'><span class='object_link'><a href="#send_sync-class_method" title="Takagi::EventBus.send_sync (method)">send_sync</a></span></span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>cache.query</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='lbrace'>{</span> <span class='label'>key:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>user:123</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='label'>timeout:</span> <span class='float'>1.0</span><span class='rparen'>)</span></code></pre>
    
  </div>


</div><h2>Defined Under Namespace</h2>
<p class="children">
  
    
      <strong class="modules">Modules:</strong> <span class='object_link'><a href="EventBus/AsyncExecutor.html" title="Takagi::EventBus::AsyncExecutor (module)">AsyncExecutor</a></span>, <span class='object_link'><a href="EventBus/Scope.html" title="Takagi::EventBus::Scope (module)">Scope</a></span>
    
  
    
      <strong class="classes">Classes:</strong> <span class='object_link'><a href="EventBus/AddressPrefix.html" title="Takagi::EventBus::AddressPrefix (class)">AddressPrefix</a></span>, <span class='object_link'><a href="EventBus/CoAPBridge.html" title="Takagi::EventBus::CoAPBridge (class)">CoAPBridge</a></span>, <span class='object_link'><a href="EventBus/Error.html" title="Takagi::EventBus::Error (class)">Error</a></span>, <span class='object_link'><a href="EventBus/Future.html" title="Takagi::EventBus::Future (class)">Future</a></span>, <span class='object_link'><a href="EventBus/Handler.html" title="Takagi::EventBus::Handler (class)">Handler</a></span>, <span class='object_link'><a href="EventBus/LRUCache.html" title="Takagi::EventBus::LRUCache (class)">LRUCache</a></span>, <span class='object_link'><a href="EventBus/Message.html" title="Takagi::EventBus::Message (class)">Message</a></span>, <span class='object_link'><a href="EventBus/MessageBuffer.html" title="Takagi::EventBus::MessageBuffer (class)">MessageBuffer</a></span>, <span class='object_link'><a href="EventBus/ObserverCleanup.html" title="Takagi::EventBus::ObserverCleanup (class)">ObserverCleanup</a></span>
    
  
</p>




  <h2>Class Attribute Summary <small><a href="#" class="summary_toggle">collapse</a></small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#message_store-class_method" title="message_store (class method)">.<strong>message_store</strong>  &#x21d2; MessageBuffer, ... </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Get current message store.</p>
</div></span>
  
</li>

    
  </ul>




  
    <h2>
      Class Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#addresses-class_method" title="addresses (class method)">.<strong>addresses</strong>  &#x21d2; Array&lt;String&gt; </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>List all registered addresses.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#config_value-class_method" title="config_value (class method)">.<strong>config_value</strong>(config_key, env_key, default)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Helper method to get configuration with fallback to ENV.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#configure_message_store-class_method" title="configure_message_store (class method)">.<strong>configure_message_store</strong>(store)  &#x21d2; MessageBuffer, ... </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Configure message store (for buffering/replay).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#consumer-class_method" title="consumer (class method)">.<strong>consumer</strong>(address, options = {}) {|message| ... } &#x21d2; String </a>
    

    
      (also: observe, on)
    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Register consumer for address (point-to-point or pub/sub).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#current_state-class_method" title="current_state (class method)">.<strong>current_state</strong>(address)  &#x21d2; Object<sup>?</sup> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Get current state for address.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#disable_message_buffering-class_method" title="disable_message_buffering (class method)">.<strong>disable_message_buffering</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Disable message buffering.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#distributed%3F-class_method" title="distributed? (class method)">.<strong>distributed?</strong>(address)  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Check if address is distributed via CoAP Uses AddressPrefix registry for extensibility.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#enable_message_buffering-class_method" title="enable_message_buffering (class method)">.<strong>enable_message_buffering</strong>(max_messages: 100, ttl: 300)  &#x21d2; MessageBuffer </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Enable default message buffering.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#handler_count-class_method" title="handler_count (class method)">.<strong>handler_count</strong>(address)  &#x21d2; Integer </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Get handler count for address.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#local_only%3F-class_method" title="local_only? (class method)">.<strong>local_only?</strong>(address)  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Check if address is local-only Uses AddressPrefix registry for extensibility.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#publish-class_method" title="publish (class method)">.<strong>publish</strong>(address, body = nil, headers: {}, scope: Scope::DEFAULT, freeze_body: true)  &#x21d2; Message </a>
    

    
      (also: notify, emit)
    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Publish message to all subscribers (pub/sub pattern).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#replay-class_method" title="replay (class method)">.<strong>replay</strong>(address, since: nil)  &#x21d2; Array&lt;Message&gt; </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Replay buffered messages for an address.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#replay_to-class_method" title="replay_to (class method)">.<strong>replay_to</strong>(address, since: nil) {|message| ... } &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Replay buffered messages to a consumer Useful for late joiners or reconnecting nodes.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#send-class_method" title="send (class method)">.<strong>send</strong>(address, body = nil, headers: {}) {|reply_message| ... } &#x21d2; Message </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Send message to single consumer (point-to-point pattern) Uses round-robin if multiple consumers registered.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#send_async-class_method" title="send_async (class method)">.<strong>send_async</strong>(address, body = nil, headers: {})  &#x21d2; Future </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Asynchronous send with Future (non-blocking).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#send_sync-class_method" title="send_sync (class method)">.<strong>send_sync</strong>(address, body = nil, headers: {}, timeout: 1.0)  &#x21d2; Message </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Synchronous send with timeout (blocking).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#shutdown-class_method" title="shutdown (class method)">.<strong>shutdown</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Shutdown EventBus (cleanup resources).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#start_cleanup-class_method" title="start_cleanup (class method)">.<strong>start_cleanup</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Start background cleanup.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#stats-class_method" title="stats (class method)">.<strong>stats</strong>  &#x21d2; Hash </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Get EventBus statistics.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#stop_cleanup-class_method" title="stop_cleanup (class method)">.<strong>stop_cleanup</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Stop background cleanup.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#subscribe_remote-class_method" title="subscribe_remote (class method)">.<strong>subscribe_remote</strong>(address, node_url) {|message| ... } &#x21d2; String </a>
    

    
      (also: subscribe)
    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Subscribe to remote CoAP observable.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#unregister-class_method" title="unregister (class method)">.<strong>unregister</strong>(consumer_id)  &#x21d2; Object </a>
    

    
      (also: cancel, unsubscribe)
    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Unregister a consumer.</p>
</div></span>
  
</li>

      
    </ul>
  


  <div id="class_attr_details" class="attr_details">
    <h2>Class Attribute Details</h2>
    
      
      <span id=""></span>
      <div class="method_details first">
  <h3 class="signature first" id="message_store-class_method">
  
    .<strong>message_store</strong>  &#x21d2; <tt><span class='object_link'><a href="EventBus/MessageBuffer.html" title="Takagi::EventBus::MessageBuffer (class)">MessageBuffer</a></span></tt>, ...  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Get current message store</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="EventBus/MessageBuffer.html" title="Takagi::EventBus::MessageBuffer (class)">MessageBuffer</a></span></tt>, <tt>Object</tt>, <tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Current message store</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


400
401
402</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/takagi/event_bus.rb', line 400</span>

<span class='kw'>def</span> <span class='id identifier rubyid_message_store'>message_store</span>
  <span class='ivar'>@message_store</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="addresses-class_method">
  
    .<strong>addresses</strong>  &#x21d2; <tt>Array&lt;String&gt;</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>List all registered addresses</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array&lt;String&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Event addresses</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


471
472
473</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/takagi/event_bus.rb', line 471</span>

<span class='kw'>def</span> <span class='id identifier rubyid_addresses'>addresses</span>
  <span class='ivar'>@handlers</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="config_value-class_method">
  
    .<strong>config_value</strong>(config_key, env_key, default)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Helper method to get configuration with fallback to ENV</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


95
96
97
98
99
100
101
102
103
104</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/takagi/event_bus.rb', line 95</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_config_value'>config_value</span><span class='lparen'>(</span><span class='id identifier rubyid_config_key'>config_key</span><span class='comma'>,</span> <span class='id identifier rubyid_env_key'>env_key</span><span class='comma'>,</span> <span class='id identifier rubyid_default'>default</span><span class='rparen'>)</span>
  <span class='comment'># Priority: Takagi.config &gt; ENV &gt; default
</span>  <span class='kw'>if</span> <span class='kw'>defined?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../Takagi.html" title="Takagi (module)">Takagi</a></span></span><span class='period'>.</span><span class='id identifier rubyid_config'><span class='object_link'><a href="../Takagi.html#config-class_method" title="Takagi.config (method)">config</a></span></span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='const'><span class='object_link'><a href="../Takagi.html" title="Takagi (module)">Takagi</a></span></span><span class='period'>.</span><span class='id identifier rubyid_config'><span class='object_link'><a href="../Takagi.html#config-class_method" title="Takagi.config (method)">config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_event_bus'>event_bus</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='id identifier rubyid_config_key'>config_key</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../Takagi.html" title="Takagi (module)">Takagi</a></span></span><span class='period'>.</span><span class='id identifier rubyid_config'><span class='object_link'><a href="../Takagi.html#config-class_method" title="Takagi.config (method)">config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_event_bus'>event_bus</span><span class='period'>.</span><span class='id identifier rubyid_public_send'>public_send</span><span class='lparen'>(</span><span class='id identifier rubyid_config_key'>config_key</span><span class='rparen'>)</span>
  <span class='kw'>elsif</span> <span class='const'>ENV</span><span class='lbracket'>[</span><span class='id identifier rubyid_env_key'>env_key</span><span class='rbracket'>]</span>
    <span class='const'>ENV</span><span class='lbracket'>[</span><span class='id identifier rubyid_env_key'>env_key</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_default'>default</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="configure_message_store-class_method">
  
    .<strong>configure_message_store</strong>(store)  &#x21d2; <tt><span class='object_link'><a href="EventBus/MessageBuffer.html" title="Takagi::EventBus::MessageBuffer (class)">MessageBuffer</a></span></tt>, ... 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Configure message store (for buffering/replay)</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
        <h5 class="example_title"><div class='inline'>
<p>Enable default buffering</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="Takagi::EventBus (class)">EventBus</a></span></span><span class='period'>.</span><span class='id identifier rubyid_enable_message_buffering'><span class='object_link'><a href="#enable_message_buffering-class_method" title="Takagi::EventBus.enable_message_buffering (method)">enable_message_buffering</a></span></span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'>
<p>Custom configuration</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="Takagi::EventBus (class)">EventBus</a></span></span><span class='period'>.</span><span class='id identifier rubyid_configure_message_store'>configure_message_store</span><span class='lparen'>(</span>
  <span class='const'><span class='object_link'><a href="EventBus/MessageBuffer.html" title="Takagi::EventBus::MessageBuffer (class)">MessageBuffer</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="EventBus/MessageBuffer.html#initialize-instance_method" title="Takagi::EventBus::MessageBuffer#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>max_messages:</span> <span class='int'>200</span><span class='comma'>,</span> <span class='label'>ttl:</span> <span class='int'>600</span><span class='rparen'>)</span>
<span class='rparen'>)</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'>
<p>Custom plugin store</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="Takagi::EventBus (class)">EventBus</a></span></span><span class='period'>.</span><span class='id identifier rubyid_configure_message_store'>configure_message_store</span><span class='lparen'>(</span><span class='const'>RedisMessageStore</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='rparen'>)</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>store</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="EventBus/MessageBuffer.html" title="Takagi::EventBus::MessageBuffer (class)">MessageBuffer</a></span></tt>, <tt>Object</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Message store instance (nil to disable)</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="EventBus/MessageBuffer.html" title="Takagi::EventBus::MessageBuffer (class)">MessageBuffer</a></span></tt>, <tt>Object</tt>, <tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Configured store</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


380
381
382</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/takagi/event_bus.rb', line 380</span>

<span class='kw'>def</span> <span class='id identifier rubyid_configure_message_store'>configure_message_store</span><span class='lparen'>(</span><span class='id identifier rubyid_store'>store</span><span class='rparen'>)</span>
  <span class='ivar'>@message_store</span> <span class='op'>=</span> <span class='id identifier rubyid_store'>store</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="consumer-class_method">
  
    .<strong>consumer</strong>(address, options = {}) {|message| ... } &#x21d2; <tt>String</tt> 
  

  
    <span class="aliases">Also known as:
    <span class="names"><span id='observe-class_method'>observe</span>, <span id='on-class_method'>on</span></span>
    </span>
  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Register consumer for address (point-to-point or pub/sub)</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
      <pre class="example code"><code><span class='id identifier rubyid_id'>id</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="Takagi::EventBus (class)">EventBus</a></span></span><span class='period'>.</span><span class='id identifier rubyid_consumer'>consumer</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sensor.temperature.room1</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_message'>message</span><span class='op'>|</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Temp: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_message'>message</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
<span class='const'><span class='object_link'><a href="" title="Takagi::EventBus (class)">EventBus</a></span></span><span class='period'>.</span><span class='id identifier rubyid_unregister'><span class='object_link'><a href="#unregister-class_method" title="Takagi::EventBus.unregister (method)">unregister</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>address</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Event address or pattern</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>options</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>{}</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Handler options</p>
</div>
      
    </li>
  
</ul>

  
    
    
    
    
    <p class="tag_title">Options Hash (<tt>options</tt>):</p>
    <ul class="option">
      
        <li>
          <span class="name">:local_only</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Only receive local messages</p>
</div>
          
        </li>
      
    </ul>
  

<p class="tag_title">Yields:</p>
<ul class="yield">
  
    <li>
      
      
        <span class='type'>(<tt>message</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Block called when message received</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Consumer ID (for unregistering)</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt>ArgumentError</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/takagi/event_bus.rb', line 292</span>

<span class='kw'>def</span> <span class='id identifier rubyid_consumer'>consumer</span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Block required</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_block'>block</span>

  <span class='id identifier rubyid_handler'>handler</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="EventBus/Handler.html" title="Takagi::EventBus::Handler (class)">Handler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="EventBus/Handler.html#initialize-instance_method" title="Takagi::EventBus::Handler#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_consumer_id'>consumer_id</span> <span class='op'>=</span> <span class='const'>SecureRandom</span><span class='period'>.</span><span class='id identifier rubyid_uuid'>uuid</span>

  <span class='ivar'>@mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='ivar'>@handlers</span><span class='lbracket'>[</span><span class='id identifier rubyid_address'>address</span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_handler'>handler</span>
    <span class='ivar'>@consumers</span><span class='lbracket'>[</span><span class='id identifier rubyid_consumer_id'>consumer_id</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_handler'>handler</span>
    <span class='ivar'>@handler_store</span><span class='lbracket'>[</span><span class='id identifier rubyid_handler'>handler</span><span class='period'>.</span><span class='id identifier rubyid_pool_id'>pool_id</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_handler'>handler</span>
  <span class='kw'>end</span>

  <span class='ivar'>@executor</span><span class='period'>.</span><span class='id identifier rubyid_register_handler'>register_handler</span><span class='lparen'>(</span><span class='id identifier rubyid_handler'>handler</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='ivar'>@executor</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:register_handler</span><span class='rparen'>)</span>

  <span class='comment'># Auto-create CoAP observable resource if distributed and not local_only
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_distributed?'>distributed?</span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:local_only</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='kw'>defined?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../Takagi.html" title="Takagi (module)">Takagi</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Base.html" title="Takagi::Base (class)">Base</a></span></span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="EventBus/CoAPBridge.html" title="Takagi::EventBus::CoAPBridge (class)">CoAPBridge</a></span></span><span class='period'>.</span><span class='id identifier rubyid_register_observable_resource'><span class='object_link'><a href="EventBus/CoAPBridge.html#register_observable_resource-class_method" title="Takagi::EventBus::CoAPBridge.register_observable_resource (method)">register_observable_resource</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="../Takagi.html" title="Takagi (module)">Takagi</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Base.html" title="Takagi::Base (class)">Base</a></span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_log_debug'>log_debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Consumer registered: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_address'>address</span><span class='embexpr_end'>}</span><span class='tstring_content'> (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_consumer_id'>consumer_id</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_consumer_id'>consumer_id</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="current_state-class_method">
  
    .<strong>current_state</strong>(address)  &#x21d2; <tt>Object</tt><sup>?</sup> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Get current state for address</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>address</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Event address</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Object</tt>, <tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Current state or nil</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


465
466
467</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/takagi/event_bus.rb', line 465</span>

<span class='kw'>def</span> <span class='id identifier rubyid_current_state'>current_state</span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='rparen'>)</span>
  <span class='ivar'>@current_states</span><span class='period'>.</span><span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="disable_message_buffering-class_method">
  
    .<strong>disable_message_buffering</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Disable message buffering</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


393
394
395
396</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/takagi/event_bus.rb', line 393</span>

<span class='kw'>def</span> <span class='id identifier rubyid_disable_message_buffering'>disable_message_buffering</span>
  <span class='ivar'>@message_store</span><span class='op'>&amp;.</span><span class='id identifier rubyid_shutdown'>shutdown</span> <span class='kw'>if</span> <span class='ivar'>@message_store</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:shutdown</span><span class='rparen'>)</span>
  <span class='ivar'>@message_store</span> <span class='op'>=</span> <span class='kw'>nil</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="distributed?-class_method">
  
    .<strong>distributed?</strong>(address)  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Check if address is distributed via CoAP Uses AddressPrefix registry for extensibility</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>address</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Event address</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


448
449
450
451
452</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/takagi/event_bus.rb', line 448</span>

<span class='kw'>def</span> <span class='id identifier rubyid_distributed?'>distributed?</span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='kw'>false</span> <span class='kw'>if</span> <span class='id identifier rubyid_address'>address</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_start_with?'>start_with?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>hooks.</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>

  <span class='const'><span class='object_link'><a href="EventBus/AddressPrefix.html" title="Takagi::EventBus::AddressPrefix (class)">AddressPrefix</a></span></span><span class='period'>.</span><span class='id identifier rubyid_distributed?'><span class='object_link'><a href="EventBus/AddressPrefix.html#distributed%3F-class_method" title="Takagi::EventBus::AddressPrefix.distributed? (method)">distributed?</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="enable_message_buffering-class_method">
  
    .<strong>enable_message_buffering</strong>(max_messages: 100, ttl: 300)  &#x21d2; <tt><span class='object_link'><a href="EventBus/MessageBuffer.html" title="Takagi::EventBus::MessageBuffer (class)">MessageBuffer</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Enable default message buffering</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>max_messages</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>100</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Max messages per address</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>ttl</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>300</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Time-to-live in seconds</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="EventBus/MessageBuffer.html" title="Takagi::EventBus::MessageBuffer (class)">MessageBuffer</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Configured buffer</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


388
389
390</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/takagi/event_bus.rb', line 388</span>

<span class='kw'>def</span> <span class='id identifier rubyid_enable_message_buffering'>enable_message_buffering</span><span class='lparen'>(</span><span class='label'>max_messages:</span> <span class='int'>100</span><span class='comma'>,</span> <span class='label'>ttl:</span> <span class='int'>300</span><span class='rparen'>)</span>
  <span class='ivar'>@message_store</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="EventBus/MessageBuffer.html" title="Takagi::EventBus::MessageBuffer (class)">MessageBuffer</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="EventBus/MessageBuffer.html#initialize-instance_method" title="Takagi::EventBus::MessageBuffer#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>max_messages:</span> <span class='id identifier rubyid_max_messages'>max_messages</span><span class='comma'>,</span> <span class='label'>ttl:</span> <span class='id identifier rubyid_ttl'>ttl</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="handler_count-class_method">
  
    .<strong>handler_count</strong>(address)  &#x21d2; <tt>Integer</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Get handler count for address</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>address</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Event address</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Number of handlers</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


478
479
480</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/takagi/event_bus.rb', line 478</span>

<span class='kw'>def</span> <span class='id identifier rubyid_handler_count'>handler_count</span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='rparen'>)</span>
  <span class='ivar'>@handlers</span><span class='lbracket'>[</span><span class='id identifier rubyid_address'>address</span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_size'>size</span> <span class='op'>||</span> <span class='int'>0</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="local_only?-class_method">
  
    .<strong>local_only?</strong>(address)  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Check if address is local-only Uses AddressPrefix registry for extensibility</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>address</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Event address</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


458
459
460</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/takagi/event_bus.rb', line 458</span>

<span class='kw'>def</span> <span class='id identifier rubyid_local_only?'>local_only?</span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='rparen'>)</span>
  <span class='const'><span class='object_link'><a href="EventBus/AddressPrefix.html" title="Takagi::EventBus::AddressPrefix (class)">AddressPrefix</a></span></span><span class='period'>.</span><span class='id identifier rubyid_local?'><span class='object_link'><a href="EventBus/AddressPrefix.html#local%3F-class_method" title="Takagi::EventBus::AddressPrefix.local? (method)">local?</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="publish-class_method">
  
    .<strong>publish</strong>(address, body = nil, headers: {}, scope: Scope::DEFAULT, freeze_body: true)  &#x21d2; <tt><span class='object_link'><a href="EventBus/Message.html" title="Takagi::EventBus::Message (class)">Message</a></span></tt> 
  

  
    <span class="aliases">Also known as:
    <span class="names"><span id='notify-class_method'>notify</span>, <span id='emit-class_method'>emit</span></span>
    </span>
  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Publish message to all subscribers (pub/sub pattern)</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
        <h5 class="example_title"><div class='inline'>
<p>Local event (default)</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="Takagi::EventBus (class)">EventBus</a></span></span><span class='period'>.</span><span class='id identifier rubyid_publish'>publish</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>system.startup</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='lbrace'>{</span> <span class='label'>version:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>1.0</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span><span class='rparen'>)</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'>
<p>Cluster-wide event</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="Takagi::EventBus (class)">EventBus</a></span></span><span class='period'>.</span><span class='id identifier rubyid_publish'>publish</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>cache.invalidate</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='lbrace'>{</span> <span class='label'>key:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>user:123</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='label'>scope:</span> <span class='symbol'>:cluster</span><span class='rparen'>)</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'>
<p>Global event (cluster + external)</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="Takagi::EventBus (class)">EventBus</a></span></span><span class='period'>.</span><span class='id identifier rubyid_publish'>publish</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sensor.temperature.room1</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='lbrace'>{</span> <span class='label'>value:</span> <span class='float'>25.5</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='label'>scope:</span> <span class='symbol'>:global</span><span class='rparen'>)</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>address</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Event address (e.g., sensor.temperature.room1)</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>body</span>
      
      
        <span class='type'>(<tt>Object</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Message body (must be shareable for Ractors)</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>headers</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>{}</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Optional message headers</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>scope</span>
      
      
        <span class='type'>(<tt>Symbol</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>Scope::DEFAULT</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Message scope (:local, :cluster, :global) - defaults to :local</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="EventBus/Message.html" title="Takagi::EventBus::Message (class)">Message</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Published message</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/takagi/event_bus.rb', line 160</span>

<span class='kw'>def</span> <span class='id identifier rubyid_publish'>publish</span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>headers:</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='label'>scope:</span> <span class='const'><span class='object_link'><a href="EventBus/Scope.html" title="Takagi::EventBus::Scope (module)">Scope</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="EventBus/Scope.html#DEFAULT-constant" title="Takagi::EventBus::Scope::DEFAULT (constant)">DEFAULT</a></span></span><span class='comma'>,</span> <span class='label'>freeze_body:</span> <span class='kw'>true</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="EventBus/Message.html" title="Takagi::EventBus::Message (class)">Message</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="EventBus/Message.html#initialize-instance_method" title="Takagi::EventBus::Message#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span><span class='comma'>,</span> <span class='label'>headers:</span> <span class='id identifier rubyid_headers'>headers</span><span class='comma'>,</span> <span class='label'>scope:</span> <span class='id identifier rubyid_scope'>scope</span><span class='comma'>,</span> <span class='label'>freeze_body:</span> <span class='id identifier rubyid_freeze_body'>freeze_body</span><span class='rparen'>)</span>

  <span class='comment'># Hook: Store message if buffering enabled
</span>  <span class='ivar'>@message_store</span><span class='op'>&amp;.</span><span class='id identifier rubyid_store'>store</span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span><span class='rparen'>)</span>

  <span class='comment'># ALWAYS deliver locally (fast in-memory)
</span>  <span class='ivar'>@mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_handlers_for'>handlers_for</span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_handler'>handler</span><span class='op'>|</span>
      <span class='id identifier rubyid_deliver_async'>deliver_async</span><span class='lparen'>(</span><span class='id identifier rubyid_handler'>handler</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span><span class='rparen'>)</span>
    <span class='kw'>end</span>

    <span class='comment'># Wildcard handlers
</span>    <span class='id identifier rubyid_wildcard_handlers'>wildcard_handlers</span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_handler'>handler</span><span class='op'>|</span>
      <span class='id identifier rubyid_deliver_async'>deliver_async</span><span class='lparen'>(</span><span class='id identifier rubyid_handler'>handler</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Scope-aware distribution
</span>  <span class='kw'>case</span> <span class='id identifier rubyid_message'>message</span><span class='period'>.</span><span class='id identifier rubyid_scope'>scope</span>
  <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="EventBus/Scope.html" title="Takagi::EventBus::Scope (module)">Scope</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="EventBus/Scope.html#CLUSTER-constant" title="Takagi::EventBus::Scope::CLUSTER (constant)">CLUSTER</a></span></span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="EventBus/Scope.html" title="Takagi::EventBus::Scope (module)">Scope</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="EventBus/Scope.html#GLOBAL-constant" title="Takagi::EventBus::Scope::GLOBAL (constant)">GLOBAL</a></span></span>
    <span class='comment'># Cluster distribution via CoAP OBSERVE
</span>    <span class='comment'># ClusterBridge.publish_to_cluster(address, message)
</span>    <span class='id identifier rubyid_log_debug'>log_debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Cluster distribution not yet implemented for scope: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_message'>message</span><span class='period'>.</span><span class='id identifier rubyid_scope'>scope</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># Global scope: external CoAP subscribers (via /.well-known/core)
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_message'>message</span><span class='period'>.</span><span class='id identifier rubyid_scope'>scope</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="EventBus/Scope.html" title="Takagi::EventBus::Scope (module)">Scope</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="EventBus/Scope.html#GLOBAL-constant" title="Takagi::EventBus::Scope::GLOBAL (constant)">GLOBAL</a></span></span>
    <span class='ivar'>@current_states</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="EventBus/CoAPBridge.html" title="Takagi::EventBus::CoAPBridge (class)">CoAPBridge</a></span></span><span class='period'>.</span><span class='id identifier rubyid_publish_to_observers'><span class='object_link'><a href="EventBus/CoAPBridge.html#publish_to_observers-class_method" title="Takagi::EventBus::CoAPBridge.publish_to_observers (method)">publish_to_observers</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Legacy distributed? check (backward compatibility)
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_distributed?'>distributed?</span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_message'>message</span><span class='period'>.</span><span class='id identifier rubyid_scope'>scope</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="EventBus/Scope.html" title="Takagi::EventBus::Scope (module)">Scope</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="EventBus/Scope.html#DEFAULT-constant" title="Takagi::EventBus::Scope::DEFAULT (constant)">DEFAULT</a></span></span>
    <span class='ivar'>@current_states</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="EventBus/CoAPBridge.html" title="Takagi::EventBus::CoAPBridge (class)">CoAPBridge</a></span></span><span class='period'>.</span><span class='id identifier rubyid_publish_to_observers'><span class='object_link'><a href="EventBus/CoAPBridge.html#publish_to_observers-class_method" title="Takagi::EventBus::CoAPBridge.publish_to_observers (method)">publish_to_observers</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_message'>message</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="replay-class_method">
  
    .<strong>replay</strong>(address, since: nil)  &#x21d2; <tt>Array&lt;<span class='object_link'><a href="EventBus/Message.html" title="Takagi::EventBus::Message (class)">Message</a></span>&gt;</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Replay buffered messages for an address</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
        <h5 class="example_title"><div class='inline'>
<p>Replay all buffered messages</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="Takagi::EventBus (class)">EventBus</a></span></span><span class='period'>.</span><span class='id identifier rubyid_replay'>replay</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sensor.temperature.room1</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'>
<p>Replay last 60 seconds</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="Takagi::EventBus (class)">EventBus</a></span></span><span class='period'>.</span><span class='id identifier rubyid_replay'>replay</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sensor.temperature.room1</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>since:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>-</span> <span class='int'>60</span><span class='rparen'>)</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>address</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Event address</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>since</span>
      
      
        <span class='type'>(<tt>Time</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Return messages since this time (nil = all)</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array&lt;<span class='object_link'><a href="EventBus/Message.html" title="Takagi::EventBus::Message (class)">Message</a></span>&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Buffered messages</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


412
413
414
415
416</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/takagi/event_bus.rb', line 412</span>

<span class='kw'>def</span> <span class='id identifier rubyid_replay'>replay</span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='label'>since:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='lbracket'>[</span><span class='rbracket'>]</span> <span class='kw'>unless</span> <span class='ivar'>@message_store</span>

  <span class='ivar'>@message_store</span><span class='period'>.</span><span class='id identifier rubyid_replay'>replay</span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='label'>since:</span> <span class='id identifier rubyid_since'>since</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="replay_to-class_method">
  
    .<strong>replay_to</strong>(address, since: nil) {|message| ... } &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Replay buffered messages to a consumer Useful for late joiners or reconnecting nodes</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
        <h5 class="example_title"><div class='inline'>
<p>Replay to new subscriber</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="Takagi::EventBus (class)">EventBus</a></span></span><span class='period'>.</span><span class='id identifier rubyid_consumer'><span class='object_link'><a href="#consumer-class_method" title="Takagi::EventBus.consumer (method)">consumer</a></span></span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sensor.temperature.room1</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_msg'>msg</span><span class='op'>|</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Temp: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
<span class='comment'># Catch up on last 5 minutes
</span><span class='const'><span class='object_link'><a href="" title="Takagi::EventBus (class)">EventBus</a></span></span><span class='period'>.</span><span class='id identifier rubyid_replay_to'>replay_to</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sensor.temperature.room1</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>since:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>-</span> <span class='int'>300</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_msg'>msg</span><span class='op'>|</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Missed: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>address</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Event address</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>since</span>
      
      
        <span class='type'>(<tt>Time</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Replay messages since this time</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Yields:</p>
<ul class="yield">
  
    <li>
      
      
        <span class='type'>(<tt>message</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Block called for each buffered message</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt>ArgumentError</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


432
433
434
435
436
437
438</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/takagi/event_bus.rb', line 432</span>

<span class='kw'>def</span> <span class='id identifier rubyid_replay_to'>replay_to</span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='label'>since:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Block required</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_block'>block</span>

  <span class='id identifier rubyid_messages'>messages</span> <span class='op'>=</span> <span class='id identifier rubyid_replay'>replay</span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='label'>since:</span> <span class='id identifier rubyid_since'>since</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_messages'>messages</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_messages'>messages</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="send-class_method">
  
    .<strong>send</strong>(address, body = nil, headers: {}) {|reply_message| ... } &#x21d2; <tt><span class='object_link'><a href="EventBus/Message.html" title="Takagi::EventBus::Message (class)">Message</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Send message to single consumer (point-to-point pattern) Uses round-robin if multiple consumers registered</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="Takagi::EventBus (class)">EventBus</a></span></span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>cache.query</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='lbrace'>{</span> <span class='label'>key:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>user:123</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_reply'>reply</span><span class='op'>|</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Cache value: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_reply'>reply</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>address</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Event address</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>body</span>
      
      
        <span class='type'>(<tt>Object</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Message body</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>headers</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>{}</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Optional headers</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Yields:</p>
<ul class="yield">
  
    <li>
      
      
        <span class='type'>(<tt>reply_message</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Optional reply handler (request-reply pattern)</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="EventBus/Message.html" title="Takagi::EventBus::Message (class)">Message</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Sent message</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/takagi/event_bus.rb', line 213</span>

<span class='kw'>def</span> <span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>headers:</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_reply_handler'>reply_handler</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_reply_address'>reply_address</span> <span class='op'>=</span> <span class='id identifier rubyid_reply_handler'>reply_handler</span> <span class='op'>?</span> <span class='id identifier rubyid_generate_reply_address'>generate_reply_address</span> <span class='op'>:</span> <span class='kw'>nil</span>

  <span class='comment'># Register temporary reply handler
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_reply_handler'>reply_handler</span>
    <span class='id identifier rubyid_consumer'>consumer</span><span class='lparen'>(</span><span class='id identifier rubyid_reply_address'>reply_address</span><span class='comma'>,</span> <span class='label'>local_only:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_reply_handler'>reply_handler</span><span class='rparen'>)</span>

    <span class='comment'># Auto-unregister after timeout
</span>    <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_sleep'>sleep</span> <span class='int'>30</span> <span class='comment'># Reply timeout
</span>      <span class='id identifier rubyid_unregister'>unregister</span><span class='lparen'>(</span><span class='id identifier rubyid_reply_address'>reply_address</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="EventBus/Message.html" title="Takagi::EventBus::Message (class)">Message</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="EventBus/Message.html#initialize-instance_method" title="Takagi::EventBus::Message#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span><span class='comma'>,</span> <span class='label'>headers:</span> <span class='id identifier rubyid_headers'>headers</span><span class='comma'>,</span> <span class='label'>reply_address:</span> <span class='id identifier rubyid_reply_address'>reply_address</span><span class='rparen'>)</span>

  <span class='ivar'>@mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_handler'>handler</span> <span class='op'>=</span> <span class='id identifier rubyid_next_handler_for'>next_handler_for</span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_deliver_async'>deliver_async</span><span class='lparen'>(</span><span class='id identifier rubyid_handler'>handler</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_handler'>handler</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_message'>message</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="send_async-class_method">
  
    .<strong>send_async</strong>(address, body = nil, headers: {})  &#x21d2; <tt><span class='object_link'><a href="EventBus/Future.html" title="Takagi::EventBus::Future (class)">Future</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Asynchronous send with Future (non-blocking)</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
      <pre class="example code"><code><span class='id identifier rubyid_future'>future</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="Takagi::EventBus (class)">EventBus</a></span></span><span class='period'>.</span><span class='id identifier rubyid_send_async'>send_async</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>cache.query</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='lbrace'>{</span> <span class='label'>key:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>user:123</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span><span class='rparen'>)</span>
<span class='comment'># ... do other work ...
</span><span class='id identifier rubyid_reply'>reply</span> <span class='op'>=</span> <span class='id identifier rubyid_future'>future</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='lparen'>(</span><span class='label'>timeout:</span> <span class='float'>1.0</span><span class='rparen'>)</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>address</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Event address</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>body</span>
      
      
        <span class='type'>(<tt>Object</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Message body</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>headers</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>{}</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Optional headers</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="EventBus/Future.html" title="Takagi::EventBus::Future (class)">Future</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Future that will contain reply</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


270
271
272
273
274
275
276
277
278</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/takagi/event_bus.rb', line 270</span>

<span class='kw'>def</span> <span class='id identifier rubyid_send_async'>send_async</span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>headers:</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_future'>future</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="EventBus/Future.html" title="Takagi::EventBus::Future (class)">Future</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="EventBus/Future.html#initialize-instance_method" title="Takagi::EventBus::Future#initialize (method)">new</a></span></span>

  <span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span><span class='comma'>,</span> <span class='label'>headers:</span> <span class='id identifier rubyid_headers'>headers</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_reply_message'>reply_message</span><span class='op'>|</span>
    <span class='id identifier rubyid_future'>future</span><span class='period'>.</span><span class='id identifier rubyid_set_value'>set_value</span><span class='lparen'>(</span><span class='id identifier rubyid_reply_message'>reply_message</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_future'>future</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="send_sync-class_method">
  
    .<strong>send_sync</strong>(address, body = nil, headers: {}, timeout: 1.0)  &#x21d2; <tt><span class='object_link'><a href="EventBus/Message.html" title="Takagi::EventBus::Message (class)">Message</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Synchronous send with timeout (blocking)</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
      <pre class="example code"><code><span class='id identifier rubyid_reply'>reply</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="Takagi::EventBus (class)">EventBus</a></span></span><span class='period'>.</span><span class='id identifier rubyid_send_sync'>send_sync</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>cache.query</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='lbrace'>{</span> <span class='label'>key:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>user:123</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='label'>timeout:</span> <span class='float'>1.0</span><span class='rparen'>)</span>
<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Cache hit: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_reply'>reply</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span><span class='lbracket'>[</span><span class='symbol'>:hit</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>address</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Event address</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>body</span>
      
      
        <span class='type'>(<tt>Object</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Message body</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>headers</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>{}</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Optional headers</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>timeout</span>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>1.0</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Timeout in seconds (default: 1.0)</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="EventBus/Message.html" title="Takagi::EventBus::Message (class)">Message</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Reply message</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt>Timeout::Error</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>If no reply received within timeout</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


248
249
250
251
252
253
254
255
256
257
258</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/takagi/event_bus.rb', line 248</span>

<span class='kw'>def</span> <span class='id identifier rubyid_send_sync'>send_sync</span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>headers:</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='label'>timeout:</span> <span class='float'>1.0</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_future'>future</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="EventBus/Future.html" title="Takagi::EventBus::Future (class)">Future</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="EventBus/Future.html#initialize-instance_method" title="Takagi::EventBus::Future#initialize (method)">new</a></span></span>

  <span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span><span class='comma'>,</span> <span class='label'>headers:</span> <span class='id identifier rubyid_headers'>headers</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_reply_message'>reply_message</span><span class='op'>|</span>
    <span class='id identifier rubyid_future'>future</span><span class='period'>.</span><span class='id identifier rubyid_set_value'>set_value</span><span class='lparen'>(</span><span class='id identifier rubyid_reply_message'>reply_message</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_future'>future</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='lparen'>(</span><span class='label'>timeout:</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='rparen'>)</span>
<span class='kw'>rescue</span> <span class='const'>Timeout</span><span class='op'>::</span><span class='const'>Error</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="EventBus/Error.html" title="Takagi::EventBus::Error (class)">Error</a></span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>No reply received for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_address'>address</span><span class='embexpr_end'>}</span><span class='tstring_content'> within </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_timeout'>timeout</span><span class='embexpr_end'>}</span><span class='tstring_content'>s</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="shutdown-class_method">
  
    .<strong>shutdown</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Shutdown EventBus (cleanup resources)</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


516
517
518
519
520
521
522
523
524
525
526</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/takagi/event_bus.rb', line 516</span>

<span class='kw'>def</span> <span class='id identifier rubyid_shutdown'>shutdown</span>
  <span class='id identifier rubyid_stop_cleanup'>stop_cleanup</span>
  <span class='ivar'>@executor</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span> <span class='kw'>if</span> <span class='kw'>defined?</span><span class='lparen'>(</span><span class='ivar'>@executor</span><span class='rparen'>)</span>
  <span class='ivar'>@current_states</span><span class='period'>.</span><span class='id identifier rubyid_clear'>clear</span>
  <span class='ivar'>@message_store</span><span class='op'>&amp;.</span><span class='id identifier rubyid_shutdown'>shutdown</span> <span class='kw'>if</span> <span class='ivar'>@message_store</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:shutdown</span><span class='rparen'>)</span>
  <span class='ivar'>@mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='ivar'>@handlers</span><span class='period'>.</span><span class='id identifier rubyid_clear'>clear</span>
    <span class='ivar'>@consumers</span><span class='period'>.</span><span class='id identifier rubyid_clear'>clear</span>
    <span class='ivar'>@handler_store</span><span class='period'>.</span><span class='id identifier rubyid_clear'>clear</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="start_cleanup-class_method">
  
    .<strong>start_cleanup</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Start background cleanup</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


506
507
508</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/takagi/event_bus.rb', line 506</span>

<span class='kw'>def</span> <span class='id identifier rubyid_start_cleanup'>start_cleanup</span>
  <span class='ivar'>@cleanup</span><span class='period'>.</span><span class='id identifier rubyid_start'>start</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="stats-class_method">
  
    .<strong>stats</strong>  &#x21d2; <tt>Hash</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Get EventBus statistics</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Statistics</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/takagi/event_bus.rb', line 484</span>

<span class='kw'>def</span> <span class='id identifier rubyid_stats'>stats</span>
  <span class='id identifier rubyid_executor_stats'>executor_stats</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='kw'>defined?</span><span class='lparen'>(</span><span class='ivar'>@executor</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@executor</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:stats</span><span class='rparen'>)</span>
                     <span class='ivar'>@executor</span><span class='period'>.</span><span class='id identifier rubyid_stats'>stats</span>
                   <span class='kw'>else</span>
                     <span class='lbrace'>{</span><span class='rbrace'>}</span>
                   <span class='kw'>end</span>
  <span class='id identifier rubyid_base_stats'>base_stats</span> <span class='op'>=</span> <span class='lbrace'>{</span>
    <span class='label'>consumers:</span> <span class='ivar'>@consumers</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span><span class='comma'>,</span>
    <span class='label'>addresses:</span> <span class='ivar'>@handlers</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span><span class='comma'>,</span>
    <span class='label'>async_executor:</span> <span class='id identifier rubyid_executor_stats'>executor_stats</span><span class='comma'>,</span>
    <span class='label'>state_cache_size:</span> <span class='ivar'>@current_states</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span><span class='comma'>,</span>
    <span class='label'>distributed_addresses:</span> <span class='id identifier rubyid_addresses'>addresses</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_a'>a</span><span class='op'>|</span> <span class='id identifier rubyid_distributed?'>distributed?</span><span class='lparen'>(</span><span class='id identifier rubyid_a'>a</span><span class='rparen'>)</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span><span class='comma'>,</span>
    <span class='label'>local_addresses:</span> <span class='id identifier rubyid_addresses'>addresses</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_a'>a</span><span class='op'>|</span> <span class='id identifier rubyid_local_only?'>local_only?</span><span class='lparen'>(</span><span class='id identifier rubyid_a'>a</span><span class='rparen'>)</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span>
  <span class='rbrace'>}</span>

  <span class='comment'># Add message buffer stats if enabled
</span>  <span class='id identifier rubyid_base_stats'>base_stats</span><span class='lbracket'>[</span><span class='symbol'>:message_buffer</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='ivar'>@message_store</span><span class='period'>.</span><span class='id identifier rubyid_stats'>stats</span> <span class='kw'>if</span> <span class='ivar'>@message_store</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:stats</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_base_stats'>base_stats</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="stop_cleanup-class_method">
  
    .<strong>stop_cleanup</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Stop background cleanup</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


511
512
513</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/takagi/event_bus.rb', line 511</span>

<span class='kw'>def</span> <span class='id identifier rubyid_stop_cleanup'>stop_cleanup</span>
  <span class='ivar'>@cleanup</span><span class='period'>.</span><span class='id identifier rubyid_stop'>stop</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="subscribe_remote-class_method">
  
    .<strong>subscribe_remote</strong>(address, node_url) {|message| ... } &#x21d2; <tt>String</tt> 
  

  
    <span class="aliases">Also known as:
    <span class="names"><span id='subscribe-class_method'>subscribe</span></span>
    </span>
  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Subscribe to remote CoAP observable</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
      <pre class="example code"><code><span class='id identifier rubyid_id'>id</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="Takagi::EventBus (class)">EventBus</a></span></span><span class='period'>.</span><span class='id identifier rubyid_subscribe_remote'>subscribe_remote</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sensor.temp.buildingA</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>coap://building-a:5683</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_msg'>msg</span><span class='op'>|</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Remote temp: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>address</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Event address</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>node_url</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Remote node URL (e.g., coap://building-a:5683)</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Yields:</p>
<ul class="yield">
  
    <li>
      
      
        <span class='type'>(<tt>message</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Block called when remote notification received</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Subscription ID</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


346
347
348</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/takagi/event_bus.rb', line 346</span>

<span class='kw'>def</span> <span class='id identifier rubyid_subscribe_remote'>subscribe_remote</span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='id identifier rubyid_node_url'>node_url</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='const'><span class='object_link'><a href="EventBus/CoAPBridge.html" title="Takagi::EventBus::CoAPBridge (class)">CoAPBridge</a></span></span><span class='period'>.</span><span class='id identifier rubyid_subscribe_remote'><span class='object_link'><a href="EventBus/CoAPBridge.html#subscribe_remote-class_method" title="Takagi::EventBus::CoAPBridge.subscribe_remote (method)">subscribe_remote</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='id identifier rubyid_node_url'>node_url</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="unregister-class_method">
  
    .<strong>unregister</strong>(consumer_id)  &#x21d2; <tt>Object</tt> 
  

  
    <span class="aliases">Also known as:
    <span class="names"><span id='cancel-class_method'>cancel</span>, <span id='unsubscribe-class_method'>unsubscribe</span></span>
    </span>
  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Unregister a consumer</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>consumer_id</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Consumer ID returned from consumer()</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/takagi/event_bus.rb', line 317</span>

<span class='kw'>def</span> <span class='id identifier rubyid_unregister'>unregister</span><span class='lparen'>(</span><span class='id identifier rubyid_consumer_id'>consumer_id</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_handler'>handler</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='ivar'>@mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_handler'>handler</span> <span class='op'>=</span> <span class='ivar'>@consumers</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_consumer_id'>consumer_id</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_handler'>handler</span>
      <span class='id identifier rubyid_list'>list</span> <span class='op'>=</span> <span class='ivar'>@handlers</span><span class='lbracket'>[</span><span class='id identifier rubyid_handler'>handler</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_list'>list</span><span class='op'>&amp;.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_handler'>handler</span><span class='rparen'>)</span>
      <span class='ivar'>@handlers</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_handler'>handler</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_list'>list</span><span class='op'>&amp;.</span><span class='id identifier rubyid_empty?'>empty?</span>
      <span class='ivar'>@handler_store</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_handler'>handler</span><span class='period'>.</span><span class='id identifier rubyid_pool_id'>pool_id</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_handler'>handler</span>

  <span class='ivar'>@executor</span><span class='period'>.</span><span class='id identifier rubyid_unregister_handler'>unregister_handler</span><span class='lparen'>(</span><span class='id identifier rubyid_handler'>handler</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='ivar'>@executor</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:unregister_handler</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_log_debug'>log_debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unregistered consumer: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_consumer_id'>consumer_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Sat Dec 13 18:29:46 2025 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.38 (ruby-3.1.3).
</div>

    </div>
  </body>
</html>